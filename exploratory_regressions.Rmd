---
title: "exploratory regressions"
author: "Brooke Staveland"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo <- FALSE,  # don't print the code chunk
  warning <- FALSE,  # don't print warnings
  message <- FALSE,  # don't print messages
  fig.width <- 12,  # set default width of figures
  fig.height <- 6,  # set default height of figures
  fig.align <- "center",  # always align figure in center
  fig.pos <- "H",  # always plot figure at the exact location of the code chunk
  cache <- TRUE)  # cache results

## libraries ##
library(tidyverse)
library(ggplot2)
library(magrittr)
# library(ggthemr)
library(grid)
library(gtable)
library(gridExtra)
library(wesanderson)
library(ggsci)
library(zoo)
library(kableExtra)
library(lme4)
library(RColorBrewer)
library(doParallel)
library(parallel)
library(foreach)
library(here)
library(fs)
library(ggcorrplot)

## hand written functions ##
source(path("R", "load_behave_data.R"))
source(path("R", "prep_behave_data.R"))
source(path("R", "stretch_start_end.R"))
source(path("R", "load_high_gamma_data.R"))
source(path("R", "rolling_window_and_baseline.R"))
source(path("R", "run_permuted_regressions.R"))
source(path("R", "compile_results.R"))
source(path("R", "run_filtered_anova.R"))
source(path("R", "merge_stepped_anova_results.R"))
# source('~/Projects/nice_r_functions/ggpaired_pretty.R')
source(path("R", 'mutate_cond.R'))

## plotting helpers ##
# ggthemr("solarized")

## paralellization ##
nCores <- 10
registerDoParallel(nCores)

```



This script is designed as the skeleton/testing ground for the regression scripts we will use in the main analyses, which will look for electrodes in which high gamma encodes different beavrioal measures from the dictator task. I will start by building some dummy data to play with.



```{r behave-prep}

# path to beahvioral files #
path_to_raw_behave <- fs::path(here(), "../dg_behave_formatted")
path_to_behave_munge <- fs::path(here(), "munge", "combined_behavioral_data.csv")
path_to_behave_clean <- fs::path(here(), "munge", "clean_behavioral_data.csv")

# concactenate behavioral data #
load_behave_data(path_to_raw_behave)

# prep behavioral data #
prep_behave_data(path_to_behave_munge)

# load clean data #
behave_data <- read.csv(path_to_behave_clean)

# filter to current subject #
behave_data <- behave_data %>% filter(SID == "DG_s11")

```

```{r behave_corrs}

behave_correl_data <- behave_data %>%
  select(-SID, -round, -ends_with("time"), -RT, -side_chosen, -X)

behavioral_cor <- cor(behave_correl_data, use = "pairwise.complete.obs")

ggcorrplot(behavioral_cor,
           lab = T,
           type = "lower",
           colors = wes_palette("Zissou1", 3, type = "continuous"))

```

I am wondering if it might make sense to start with the most derived var as the spotlight, ie disaventageous versus adventageous inequality.

```{r load-hg-data-presentation-locked}

# necessary paths #
file_path_to_electrode_names <- path(here(), "munge", "IR35_electrodes_presentation_locked.csv")
file_path_to_hg_data <- path(here(), "munge", "IR35_hg_munge_presentation_locked.csv")
file_path_to_elecs_of_interest <- path(here(), "munge", "IR35_elecs_of_interest.csv")

# load data #
hg_data <- load_high_gamma_data(file_path_to_hg_data, file_path_to_electrode_names, "V952", "V953")
elecs_to_use <- read.csv(file_path_to_elecs_of_interest)

# filter to good electrodes #
hg_data <- hg_data %>% filter(grepl(paste(elecs_to_use$Electrode, collapse = "|"), electrodes))

# average and baseline #
hg_clean <- rolling_window_and_baseline(hg_data, lWin = 100, lOver = 50, choice_locked = F)

# with behavior #
hg_behave <- merge.data.frame(hg_clean, behave_data, by.x = "trial", by.y = "round", all.x = T, all.y = F)
write.csv(hg_behave, path(here(), "munge", "hg_behave_presentation_locked.csv"))

```


```{r load-hg-data-choice-locked}

# necessary paths #
file_path_to_electrode_names <- path(here(), "munge", "IR35_electrodes_choice_locked_cut_fixation.csv")
file_path_to_hg_data <- path(here(), "munge", "IR35_hg_munge_choice_locked_cut_fixation.csv")
file_path_to_elecs_of_interest <- path(here(), "munge", "IR35_elecs_of_interest.csv")

# load data #
hg_data <- load_high_gamma_data(file_path_to_hg_data, file_path_to_electrode_names, "V2351", "V2352")
elecs_to_use <- read.csv(file_path_to_elecs_of_interest)

# filter to good electrodes #
hg_data <- hg_data %>% filter(grepl(paste(elecs_to_use$Electrode, collapse = "|"), electrodes))

# average and baseline #
hg_clean <- rolling_window_and_baseline(hg_data, lWin = 100, lOver = 50, choice_locked = T)

# with behavior #
hg_behave <- merge.data.frame(hg_clean, behave_data, by.x = "trial", by.y = "round", all.x = T, all.y = F)
write.csv(hg_behave, path(here(), "munge", "hg_behave_choice_locked_cut_fixation.csv"))

```


```{r test_num_of_bins_to_exclude}

hg_test <- hg_clean %>% 
  filter(electrodes == "RAM1-RAM2") %>% 
  select(trial, electrodes, 23:62) %>%
  gather(key = "bin", value = "hg", -electrodes, - trial) %>%
  group_by(bin) %>%
  mutate(na_num = sum(is.na(hg)))

hg_test %>%
  ggplot(., aes(x= bin, y = na_num)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))


```


I played a round quite a bit with the gamma visualization by trial depedning on where we cut off the reaction times. 1 seconds dramatically reduces the number of NAs, and looks pretty good visually. That said, it will be very different for different people.

So looking back to the reaction time analysis the cut off to recover most trials is .5 seconds. Since we will do correction via cluster, I think this preserves tha majority of the data. This means findings the max reaction time for each person and cutting bins that are within 500ms of that time. 

But that cuts soooo many bins. So I have chickened out and am gonna run it with .75s seconds before choice


```{r hg-eda-means}

ofc_elecs <- elecs_to_use %>% filter(ofc_loc_meeting == 1) %>% select(Electrode)
insula_elecs <- elecs_to_use %>% filter(insula_loc_meeting == 1) %>% select(Electrode)
mfg_elecs <- elecs_to_use %>% filter(mfg_loc_meeting == 1) %>% select(Electrode)
sts_elecs <- elecs_to_use %>% filter(sts_loc_meeting == 1) %>% select(Electrode)
hinal_elecs <- elecs_to_use %>% filter(hinal_loc_meeting == 1) %>% select(Electrode)
ca1_elecs <- elecs_to_use %>% filter(ca1_loc_meeting == 1) %>% select(Electrode)

hg_eda_summary <- hg_eda %>%
  group_by(electrodes) %>%
  select(-trial) %>%
  summarise_all(list(function(x) mean(x, na.rm = T), function(x) mean(x, na.rm = T) - sd(x, na.rm = T), function(x) mean(x, na.rm = T) + sd(x, na.rm = T))) %>%
  gather(key = "bin", value = "gamma", -electrodes) %>%
  mutate(function_type = if_else(grepl("_fn1", bin), "mean", if_else(grepl("_fn2", bin), "min", "max"))) %>%
  mutate(bin = gsub("pre_", "-", gsub("post_", "", bin))) %>%
  mutate(bin = as.numeric(gsub("_.*", "", bin))) %>%
  spread(key = function_type, value = gamma)

hg_eda_summary %>%
  filter(grepl(paste(ofc_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_ribbon(aes(ymin = min, ymax = max), alpha = .1) +
  # geom_vline(xintercept = 1.2613816 * 1000) +
  theme(panel.background = element_rect(fill = "white")) + 
  ggtitle("OFC")

hg_eda_summary %>%
  filter(grepl(paste(insula_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) +
  # geom_vline(xintercept = 1.2613816 * 1000) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(9)) +
  scale_color_manual(values = getPalette(9)) +
  ggtitle("Insula")

hg_eda_summary %>%
  filter(grepl(paste(mfg_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 1000) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(25)) +
  scale_color_manual(values = getPalette(25)) +
  ggtitle("MFG")

hg_eda_summary %>%
  filter(grepl(paste(sts_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 100) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(15)) +
  scale_color_manual(values = getPalette(15)) +
  ggtitle("STS")

hg_eda_summary %>%
  filter(grepl(paste(hinal_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 10) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(9)) +
  scale_color_manual(values = getPalette(9)) +
  ggtitle("Perihinal & Entrohinal")

hg_eda_summary %>%
  filter(grepl(paste(ca1_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 100) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(9)) +
  scale_color_manual(values = getPalette(9)) +
  ggtitle("CA1")

```

```{r hg_plots}

hg_data_full <- load_high_gamma_data(file_path_to_hg_data, file_path_to_electrode_names, "V3201", "V3202")
indicies <- hg_data_full %>% select(trial, electrodes)
hg_data <- hg_data_full %>% select(starts_with("time"))

baseline_df <- hg_data[, 1:200]
baseline <- apply(baseline_df, 1, function(x) mean(x, na.rm = T))

hg_data_tmp <- hg_data[, 201:ncol(hg_data)]
hg_data_baselined <- apply(hg_data_tmp, 2, function(col) t(as.vector(col - baseline)))
hg_data_baselined <- as.data.frame(hg_data_baselined)
hg_data_baselined <- cbind(hg_data_baselined, indicies)

hg_raw_plot <- merge.data.frame(hg_data_baselined, behave_data, by.x = "trial", by.y = "round", all.x = T, all.y = F)
hg_raw_plot %>%
  select(electrodes, RT, trial, starts_with("time")) %>%
  filter(electrodes == "LOF1-LOF2") %>%
  arrange(desc(RT)) %>%
  mutate(trial = factor(trial, levels = trial)) %>%
  gather(key = "time", value = "gamma", -electrodes, -trial, -RT) %>%
  mutate(time = as.numeric(gsub("time_", "", time))) %>%
  ggplot(., aes(x = time, y = trial, color = gamma, fill = gamma)) +
  geom_tile() + 
  geom_point(aes(y = trial, x = RT*1000), color = "white") + 
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  scale_fill_viridis()   +
  scale_color_viridis() +
  ggtitle("LOF1-LOF2")
  

```


```{r regressions, eval=FALSE}

# see ./analysis/batch_regression_script_par.R for current regression analyses #

```

```{r fake, eval=FALSE}

fake_adv <- read.csv(path(here(), "results", "fake_results_advantageous.csv"))
fake_dis <- read.csv(path(here(), "results", "fake_results_disadvantageous.csv"))

fake_adv %>%
  select (-X) %>%
  kable() %>%
  add_header_above(c("FAKE: Advantageous Inequity" = 8)) %>%
  kable_styling(position = "center")


fake_dis %>%
  select (-X) %>%
  kable() %>%
  add_header_above(c("FAKE: Disadvantageous Inequity" = 8)) %>%
  kable_styling(position = "center")

```

```{r concactenate-results}

regions_to_combine <- c("OFC", "Insula", "Cingulate", "STS", "MFG")
all_results <- compile_results(regions_to_combine)

```


```{r anovas}
run_filtered_anova(ofc_results, hg_behave,  region_name = "OFC", all_results = T)
run_filtered_anova(cingulate_results, hg_behave,  region_name = "Cingulate")
run_filtered_anova(insula_results, hg_behave, region_name = "Insula")
run_filtered_anova(mfg_results, hg_behave, region_name = "MFG")
run_filtered_anova(sts_results, hg_behave,  region_name = "STS")
run_filtered_anova(all_results, hg_behave,  region_name = "All")

## ofc ##
region_name <- "OFC"
ofc_results_dis <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_disadvantageous.csv")))
ofc_results_adv <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_advantageous.csv")))

ofc_results_dis %>%
  select (-X, -X.1) %>%
  kable() %>%
  add_header_above(c("Insula: Disadvantageous Inequity" = 11)) %>%
  kable_styling(position = "center")

ofc_results_adv %>%
  select (-X, -X.1) %>%
  kable() %>%
  # add_header_above(c("OFC: Advantageous Inequity" = 8)) %>%
  kable_styling(position = "center")

## insula ##
region_name <- "Insula"
insula_results_dis <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_disadvantageous.csv")))
insula_results_adv <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_advantageous.csv")))

insula_results_dis %>%
  select (-X, -X.1) %>%
  kable() %>%
  add_header_above(c("Insula: Disadvantageous Inequity" =9 )) %>%
  kable_styling(position = "center")

insula_results_adv %>%
  select (-X, -X.1) %>%
  kable() %>%
  add_header_above(c("Insula: Advantageous Inequity" = 12)) %>%
  kable_styling(position = "center")

## All Results ##
region_name <- "All"
all_results_dis <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_disadvantageous.csv")))
all_results_adv <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_advantageous.csv")))

all_results_dis %>%
  select (-X, -X.1) %>%
  kable() %>%
  add_header_above(c("All: Disadvantageous Inequity" = 13 )) %>%
  kable_styling(position = "center")

all_results_adv %>%
  select (-X, -X.1) %>%
  kable() %>%
  add_header_above(c("All: Advantageous Inequity" = 13)) %>%
  kable_styling(position = "center")

```

```{r prep-filter-anova-viz}
regions_to_combine <- c("OFC", "Insula", "Cingulate", "STS")
regression_results <- compile_results(regions_to_combine)

run_filtered_anova(regression_results, hg_behave,  region_name = "All", all_results = T)

region_name <- "All"
adv_results_for_plots <- read.csv(fs::path(here(), "results", paste0(region_name, "_anova_results_advantageous.csv")))
dis_results_for_plots <- read.csv(fs::path(here(), "results", paste0(region_name, "_anova_results_disadvantageous.csv")))
```

```{r plot-filter-anovas}
ggthemr::ggthemr("pale", layout = "plain")
getPalette = colorRampPalette(brewer.pal(3, "Set1"))

adv_results_for_plots %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_p < 0.05, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
  ggplot(., aes( x = bin, y = diff_adj_r2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(3))) +
  scale_color_manual(values = c("grey", getPalette(3))) +
  labs(y = "Difference in Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Advantageous Inequality Results")

dis_results_for_plots %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_p < 0.05, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
  ggplot(., aes( x = bin, y = diff_adj_r2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(3)[2:4])) +
  scale_color_manual(values = c("grey", getPalette(3)[2:4])) +
  labs(y = "Difference in Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Disdvantageous Inequality Results")


regression_results %>%
  filter(predictor == "self_payoff") %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Self Payoff Results")

regression_results %>%
  filter(predictor == "self_foregone") %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Self Foregone Results")

regression_results %>%
  filter(predictor == "other_payoff") %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Other Payoff Results")

regression_results %>%
  filter(predictor == "other_foregone") %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Other Foregone Results")

```

```{r correct-filtered-anovas}

adv_results_for_plots %>%
  mutate_cond(perm_p < .05 & p < .05, anova_p = p.adjust(anova_p, "hochberg")) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_p < 0.05, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
  ggplot(., aes( x = bin, y = diff_adj_r2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(3))) +
  scale_color_manual(values = c("grey", getPalette(3))) +
  labs(y = "Difference in Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Advantageous Inequality Results")

dis_results_for_plots %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_p < 0.05, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
  ggplot(., aes( x = bin, y = diff_adj_r2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
  theme( panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(3)[2:4])) +
  scale_color_manual(values = c("grey", getPalette(3)[2:4])) +
  labs(y = "Difference in Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Disdvantageous Inequality Results")

dis_results_for_plots %>% filter(electrode == "LTH8-LTH9") %>% kable(.)

```


```{r stepwise-anovas-prep, eval =F}

# concatenate results #
regions_to_combine <- c("OFC", "Insula", "Cingulate", "STS")
anova_results <- merge_stepped_anova_results(regions_to_combine)

anova_regression_results <- merge.data.frame(anova_results, regression_results, by.x = c("electrode", "region", "first_pred"), by.y = c("electrode", "region", "predictor"), all.x = T, all.y = F)

```

```{r stepwise-anova-viz, eval = F}

anova_regression_results %>%
  filter(first_pred == "ineq_advent") %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Ineq Advent Stepped Anova Results: all sig except self foregone")


anova_regression_results %>%
  filter(first_pred == "ineq_disadvent" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Ineq Disdvent Stepped Anova Results:  all sig ")

anova_regression_results %>%
  filter(first_pred == "self_payoff" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Self Payoff Stepped Anova Results:  all sig ")

anova_regression_results %>%
  filter(first_pred == "other_payoff" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Other Payoff Stepped Anova Results:  all sig except ineq disadvant")

anova_regression_results %>%
  filter(first_pred == "self_foregone" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Self Foregone Stepped Anova Results:  all sig except ineq disadvant")

anova_regression_results %>%
  filter(first_pred == "other_foregone" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Other Forgeone Stepped Anova Results: all sig except ineq disadvant")


```


# Prediction HG -> choice

maybe after regions are identified in first couple of subjects so it can be truly uniased in the later subjects

