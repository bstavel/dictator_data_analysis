---
title: "exploratory regressions"
author: "Brooke Staveland"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo <- FALSE,  # don't print the code chunk
  warning <- FALSE,  # don't print warnings
  message <- FALSE,  # don't print messages
  fig.width <- 12,  # set default width of figures
  fig.height <- 6,  # set default height of figures
  fig.align <- "center",  # always align figure in center
  fig.pos <- "H",  # always plot figure at the exact location of the code chunk
  cache <- TRUE)  # cache results

## libraries ##
library(tidyverse)
library(ggplot2)
library(magrittr)
# library(ggthemr)
library(grid)
library(gtable)
library(gridExtra)
library(wesanderson)
library(ggsci)
library(zoo)
library(kableExtra)
library(lme4)
library(RColorBrewer)
library(doParallel)
library(parallel)
library(foreach)
library(here)
library(fs)
library(ggcorrplot)

## hand written functions ##
source(path("R", "load_behave_data.R"))
source(path("R", "prep_behave_data.R"))
source(path("R", "stretch_start_end.R"))
source(path("R", "load_high_gamma_data.R"))
source(path("R", "rolling_window_and_baseline.R"))
source(path("R", "run_permuted_regressions.R"))
source(path("R", "compile_results.R"))
source(path("R", "run_filtered_anova.R"))
# source('~/Projects/nice_r_functions/ggpaired_pretty.R')
source(path("R", 'mutate_cond.R'))

## plotting helpers ##
# ggthemr("solarized")

## paralellization #
nCores <- 10
registerDoParallel(nCores)

```



This script is designed as the skeleton/testing ground for the regression scripts we will use in the main analyses, which will look for electrodes in which high gamma encodes different beavrioal measures from the dictator task. I will start by building some dummy data to play with.



```{r behave-prep}

# path to beahvioral files #
path_to_raw_behave <- fs::path(here(), "../dg_behave_formatted")
path_to_behave_munge <- fs::path(here(), "munge", "combined_behavioral_data.csv")
path_to_behave_clean <- fs::path(here(), "munge", "clean_behavioral_data.csv")

# concactenate behavioral data #
load_behave_data(path_to_raw_behave)

# prep behavioral data #
prep_behave_data(path_to_behave_munge)

# load clean data #
behave_data <- read.csv(path_to_behave_clean)

# filter to current subject #
behave_data <- behave_data %>% filter(SID == "DG_s11")

```

```{r behave_corrs}

behave_correl_data <- behave_data %>%
  select(-SID, -round, -ends_with("time"), -RT, -side_chosen, -X)

behavioral_cor <- cor(behave_correl_data, use = "pairwise.complete.obs")

ggcorrplot(behavioral_cor,
           lab = T,
           type = "lower",
           colors = wes_palette("Zissou1", 3, type = "continuous"))

```

I am wondering if it might make sense to start with the most derived var as the spotlight, ie disaventageous versus adventageous inequality.

```{r load-hg-data}

# necessary paths #
file_path_to_electrode_names <- path(here(), "munge", "IR35_electrodes.csv")
file_path_to_hg_data <- path(here(), "munge", "IR35_hg_munge.csv")
file_path_to_elecs_of_interest <- path(here(), "munge", "IR35_elecs_of_interest.csv")

# load data #
hg_data <- load_high_gamma_data(file_path_to_hg_data, file_path_to_electrode_names)
elecs_to_use <- read.csv(file_path_to_elecs_of_interest)

# filter to good electrodes #
hg_data <- hg_data %>% filter(grepl(paste(elecs_to_use$Electrode, collapse = "|"), electrodes))

# average and baseline #
hg_clean <- rolling_window_and_baseline(hg_data, lWin = 100, lOver = 50)

# create temp data for visualiztion #
half_index <- sample(1:228, 114)
hg_eda <- hg_clean %>% filter(trial %in% half_index)

# with behavior #
hg_behave <- merge.data.frame(hg_clean, behave_data, by.x = "trial", by.y = "round", all.x = T, all.y = F)

```

```{r hg-eda-means}

ofc_elecs <- elecs_to_use %>% filter(ofc_loc_meeting == 1) %>% select(Electrode)
insula_elecs <- elecs_to_use %>% filter(insula_loc_meeting == 1) %>% select(Electrode)
mfg_elecs <- elecs_to_use %>% filter(mfg_loc_meeting == 1) %>% select(Electrode)
sts_elecs <- elecs_to_use %>% filter(sts_loc_meeting == 1) %>% select(Electrode)
hinal_elecs <- elecs_to_use %>% filter(hinal_loc_meeting == 1) %>% select(Electrode)
ca1_elecs <- elecs_to_use %>% filter(ca1_loc_meeting == 1) %>% select(Electrode)

hg_eda_summary <- hg_eda %>%
  group_by(electrodes) %>%
  select(-trial) %>%
  summarise_all(mean) %>%
  gather(key = "bin", value = "gamma", -electrodes) %>%
  mutate(bin = as.numeric(gsub("bin_", "", bin)))

hg_eda_summary %>%
  filter(grepl(paste(ofc_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = gamma, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 1000) +
  theme(panel.background = element_rect(fill = "white")) + 
  ggtitle("OFC")

hg_eda_summary %>%
  filter(grepl(paste(insula_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = gamma, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 1000) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(9)) +
  scale_color_manual(values = getPalette(9)) +
  ggtitle("Insula")

hg_eda_summary %>%
  filter(grepl(paste(mfg_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = gamma, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 1000) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(25)) +
  scale_color_manual(values = getPalette(25)) +
  ggtitle("MFG")

hg_eda_summary %>%
  filter(grepl(paste(sts_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = gamma, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 100) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(15)) +
  scale_color_manual(values = getPalette(15)) +
  ggtitle("STS")

hg_eda_summary %>%
  filter(grepl(paste(hinal_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = gamma, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 10) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(9)) +
  scale_color_manual(values = getPalette(9)) +
  ggtitle("Perihinal & Entrohinal")

hg_eda_summary %>%
  filter(grepl(paste(ca1_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = gamma, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 100) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(9)) +
  scale_color_manual(values = getPalette(9)) +
  ggtitle("CA1")


```
```{r hg-eda-bin}

hg_behave_eda <- merge.data.frame(hg_eda, behave_data, by.x = "trial", by.y = "round", all.x = T, all.y = F)

hg_behave_eda <- hg_behave_eda %>%
  select(starts_with("bin_"), RT, electrodes, trial) %>%
  mutate(rt_bin = RT * 10) %>%
  gather(key = "bin", value = "gamma", -electrodes, -RT, -electrodes, -trial, -rt_bin) %>%
  mutate(bin = as.numeric(gsub("bin_", "", bin)))
  
hg_behave_eda_filtered <- hg_behave_eda %>%
  group_by(electrodes, trial, rt_bin) %>%
  mutate_cond(bin > rt_bin, gamma = 999999)

hg_behave_eda_filtered <- hg_behave_eda_filtered %>% filter(gamma < 999999)

hg_behave_eda_binned <- hg_behave_eda_filtered %>%
  ungroup() %>%
  group_by(trial, electrodes) %>%
  arrange(desc(bin)) %>%
  mutate(reverse_bins = c(3:rt_bin)) # because we cut the first two bins


hg_behave_eda_binned %>%
  filter(grepl(paste(ofc_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = reverse_bins, y = gamma, color = trial, fill = trial)) +
  geom_point(alpha = .1) +
  theme(panel.background = element_rect(fill = "white")) + 
  facet_wrap(~electrodes) +
  ggtitle("OFC")


hg_behave_eda_binned %>%
  filter(grepl(paste(ofc_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = reverse_bins, y = gamma, color = trial, fill = trial)) +
  geom_point(alpha = .1) +
  theme(panel.background = element_rect(fill = "white")) + 
  facet_wrap(~electrodes) +
  ggtitle("OFC")


```
```{r help-with-choice-locked}

# brain_behave_data <- brain_behave_data %>%
#   mutate(rt_bin = (RT * 10) + 10) %>%
#   gather(key = "bin", value = "gamma", starts_with("bin_")) %>%
#   mutate(bin = as.numeric(gsub("bin_", "", bin))) %>%
#   group_by(electrodes, trial, rt_bin) %>%
#   mutate_cond(bin > rt_bin, gamma = 999999)
# 
# brain_behave_data_filtered <- brain_behave_data %>% 
#   filter(gamma < 999999) %>%
#   ungroup() %>%
#   group_by(trial, electrodes) %>%
#   arrange(desc(bin)) %>%
#   mutate(reverse_bins = c(3:rt_bin)) %>% # because we cut the first two bins
#   mutate(reverse_bins = paste0("bin_", reverse_bins)) %>%
#   spread(key = reverse_bins, value = gamma)


```

```{r regressions, eval=FALSE}

# see ./analysis/batch_regression_script_par.R for current regression analyses #

```

```{r fake, eval=FALSE}

fake_adv <- read.csv(path(here(), "results", "fake_results_advantageous.csv"))
fake_dis <- read.csv(path(here(), "results", "fake_results_disadvantageous.csv"))

fake_adv %>%
  select (-X) %>%
  kable() %>%
  add_header_above(c("FAKE: Advantageous Inequity" = 8)) %>%
  kable_styling(position = "center")


fake_dis %>%
  select (-X) %>%
  kable() %>%
  add_header_above(c("FAKE: Disadvantageous Inequity" = 8)) %>%
  kable_styling(position = "center")

```

```{r concactenate-results}

regions_to_combine <- c("OFC", "Insula")

regression_results <- compile_results(regions_to_combine)

insula_results <- compile_results("Insula")

```


```{r anovas}
run_filtered_anova(ofc_results, hg_behave,  region_name = "OFC")
run_filtered_anova(cingulate_results, hg_behave,  region_name = "Cingulate")
run_filtered_anova(insula_results, hg_behave, region_name = "Insula")
run_filtered_anova(mfg_results, hg_behave, region_name = "MFG")
run_filtered_anova(sts_results, hg_behave,  region_name = "STS")

## ofc ##
ofc_results_dis <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_disadvantageous.csv")))
ofc_results_adv <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_advantageous.csv")))

ofc_results_dis %>%
  select (-X, -X.1) %>%
  kable() %>%
  add_header_above(c("Insula: Disadvantageous Inequity" = 11)) %>%
  kable_styling(position = "center")

ofc_results_adv %>%
  select (-X, -X.1) %>%
  kable() %>%
  # add_header_above(c("OFC: Advantageous Inequity" = 8)) %>%
  kable_styling(position = "center")

## insula ##
region_name <- "Insula"
insula_results_dis <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_disadvantageous.csv")))
insula_results_adv <- read.csv(path(here(), "results", paste0(region_name, "_anova_results_advantageous.csv")))

insula_results_dis %>%
  select (-X, -X.1) %>%
  kable() %>%
  add_header_above(c("Insula: Disadvantageous Inequity" =9 )) %>%
  kable_styling(position = "center")

insula_results_adv %>%
  select (-X, -X.1) %>%
  kable() %>%
  add_header_above(c("Insula: Advantageous Inequity" = 12)) %>%
  kable_styling(position = "center")

```

```{r stepwise-anovas}


```


# Prediction HG -> choice

maybe after regions are identified in first couple of subjects so it can be truly uniased in the later subjects

