---
title: "exploratory regressions"
author: "Brooke Staveland"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo <- FALSE,  # don't print the code chunk
  warning <- FALSE,  # don't print warnings
  message <- FALSE,  # don't print messages
  fig.width <- 12,  # set default width of figures
  fig.height <- 6,  # set default height of figures
  fig.align <- "center",  # always align figure in center
  fig.pos <- "H",  # always plot figure at the exact location of the code chunk
  cache <- TRUE)  # cache results

## libraries ##
library(tidyverse)
library(ggplot2)
library(magrittr)
# library(ggthemr)
library(grid)
library(gtable)
library(gridExtra)
library(wesanderson)
library(ggsci)
library(zoo)
library(kableExtra)
library(lme4)
library(RColorBrewer)
library(doParallel)
library(parallel)
library(foreach)
library(here)
library(fs)
library(ggcorrplot)
library(viridis)
library(lmtest)

## hand written functions ##
source(path("R", "load_behave_data.R"))
source(path("R", "prep_behave_data.R"))
source(path("R", "stretch_start_end.R"))
source(path("R", "load_high_gamma_data.R"))
source(path("R", "rolling_window_and_baseline.R"))
source(path("R", "run_permuted_regressions.R"))
source(path("R", "compile_results.R"))
source(path("R", "run_filtered_anova.R"))
source(path("R", "merge_stepped_anova_results.R"))
# source('~/Projects/nice_r_functions/ggpaired_pretty.R')
source(path("R", 'mutate_cond.R'))

## plotting helpers ##
# ggthemr("solarized")

## paralellization ##
nCores <- 2
registerDoParallel(nCores)

```



This script is designed as the skeleton/testing ground for the regression scripts we will use in the main analyses, which will look for electrodes in which high gamma encodes different beavrioal measures from the dictator task. I will start by building some dummy data to play with.


```{r behave-prep}

# path to beahvioral files #
path_to_raw_behave <- fs::path(here(), "../dg_behave_formatted")
path_to_behave_munge <- fs::path(here(), "munge", "combined_behavioral_data.csv")
path_to_behave_clean <- fs::path(here(), "munge", "clean_behavioral_data.csv")

# concactenate behavioral data #
load_behave_data(path_to_raw_behave)

# prep behavioral data #
prep_behave_data(path_to_behave_munge)

# load clean data #
behave_data <- read.csv(path_to_behave_clean)

# filter to current subject #
behave_data <- behave_data %>% filter(SID == "DG_s11")

```

```{r behave_corrs}

behave_correl_data <- behave_data %>%
  select(-SID, -round, -ends_with("time"), -RT, -side_chosen, -X)

behavioral_cor <- cor(behave_correl_data, use = "pairwise.complete.obs")

ggcorrplot(behavioral_cor,
           lab = T,
           type = "lower",
           colors = wes_palette("Zissou1", 3, type = "continuous"))

```

I am wondering if it might make sense to start with the most derived var as the spotlight, ie disaventageous versus adventageous inequality.

```{r load-hg-data-presentation-locked}

# necessary paths #
file_path_to_electrode_names <- path(here(), "munge", "IR39_electrodes_presentation_locked.csv")
file_path_to_hg_data <- path(here(), "munge", "IR39_hg_munge_presentation_locked.csv")
file_path_to_elecs_of_interest <- path(here(), "munge", "IR39_elecs_of_interest.csv")

# load data #
hg_data <- load_high_gamma_data(file_path_to_hg_data, file_path_to_electrode_names, "V952", "V953")
elecs_to_use <- read.csv(file_path_to_elecs_of_interest)

# filter to good electrodes #
hg_data <- hg_data %>% filter(grepl(paste(elecs_to_use$Electrode, collapse = "|"), electrodes))

# average and baseline #
hg_clean <- rolling_window_and_baseline(hg_data, lWin = 100, lOver = 50, choice_locked = F)

# with behavior #
hg_behave <- merge.data.frame(hg_clean, behave_data, by.x = "trial", by.y = "round", all.x = T, all.y = F)
write.csv(hg_behave, path(here(), "munge", "IR39", "hg_behave_presentation_locked.csv"))

```


```{r load-hg-data-choice-locked}

# necessary paths #
file_path_to_electrode_names <- path(here(), "munge", "IR35_electrodes_choice_locked_cut_fixation.csv")
file_path_to_hg_data <- path(here(), "munge", "IR35_hg_munge_choice_locked_cut_fixation.csv")
file_path_to_elecs_of_interest <- path(here(), "munge", "IR35_elecs_of_interest.csv")

# load data #
hg_data <- load_high_gamma_data(file_path_to_hg_data, file_path_to_electrode_names)
elecs_to_use <- read.csv(file_path_to_elecs_of_interest)

# filter to good electrodes #
hg_data <- hg_data %>% filter(grepl(paste(elecs_to_use$Electrode, collapse = "|"), electrodes))

# average and baseline #
hg_clean <- rolling_window_and_baseline(hg_data, baseline_csv = "baseline_IR35.csv", lWin = 200, lOver = 150, choice_locked = T)

# create temp data for visualiztion #
half_index <- sample(1:228, 114)
hg_eda <- hg_clean %>% filter(trial %in% half_index)


# with behavior #
hg_behave <- merge.data.frame(hg_clean, behave_data, by.x = "trial", by.y = "round", all.x = T, all.y = F)
write.csv(hg_behave, path(here(), "munge", "hg_behave_choice_locked_cut_fixation.csv"))

```


```{r test_num_of_bins_to_exclude, include=F}

hg_test <- hg_clean %>% 
  filter(electrodes == "RAM1-RAM2") %>% 
  select(trial, electrodes, 23:62) %>%
  gather(key = "bin", value = "hg", -electrodes, - trial) %>%
  group_by(bin) %>%
  mutate(na_num = sum(is.na(hg)))

hg_test %>%
  ggplot(., aes(x= bin, y = na_num)) +
  geom_col() +
  theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust = 1))


```


I played a round quite a bit with the gamma visualization by trial depedning on where we cut off the reaction times. 1 seconds dramatically reduces the number of NAs, and looks pretty good visually. That said, it will be very different for different people.

So looking back to the reaction time analysis the cut off to recover most trials is .5 seconds. Since we will do correction via cluster, I think this preserves tha majority of the data. This means findings the max reaction time for each person and cutting bins that are within 500ms of that time. 

But that cuts soooo many bins. So I have chickened out and am gonna run it with .75s seconds before choice


```{r hg-eda-means}

ofc_elecs <- elecs_to_use %>% filter(ofc_loc_meeting == 1) %>% select(Electrode)
insula_elecs <- elecs_to_use %>% filter(insula_loc_meeting == 1) %>% select(Electrode)
mfg_elecs <- elecs_to_use %>% filter(mfg_loc_meeting == 1) %>% select(Electrode)
sts_elecs <- elecs_to_use %>% filter(sts_loc_meeting == 1) %>% select(Electrode)
hinal_elecs <- elecs_to_use %>% filter(hinal_loc_meeting == 1) %>% select(Electrode)
ca1_elecs <- elecs_to_use %>% filter(ca1_loc_meeting == 1) %>% select(Electrode)

hg_eda_behave <- merge.data.frame(hg_eda, behave_data, by.y = "round", by.x = "trial")

hg_eda_summary <- hg_eda_behave %>%
  group_by(electrodes) %>%
  summarise_at(vars(starts_with("pre"), starts_with("post")), list(function(x) mean(x, na.rm = T), function(x) mean(x, na.rm = T) - sd(x, na.rm = T), function(x) mean(x, na.rm = T) + sd(x, na.rm = T))) %>%
  gather(key = "bin", value = "gamma", -electrodes) %>%
  mutate(function_type = if_else(grepl("_fn1", bin), "mean", if_else(grepl("_fn2", bin), "min", "max"))) %>%
  mutate(bin = gsub("pre_", "-", gsub("post_", "", bin))) %>%
  mutate(bin = as.numeric(gsub("_.*", "", bin))) %>%
  spread(key = function_type, value = gamma)


hg_eda_summary %>%
  filter(grepl(paste(ofc_elecs$Electrode, collapse = "|"), electrodes)) %>%
  # mutate(advent = if_else(ineq_disadvent > 0, "Advantageous", "Disadvantageous")) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_ribbon(aes(ymin = min, ymax = max), alpha = .1) +
  # geom_vline(xintercept = 1.2613816 * 1000) +
  theme(panel.background = element_rect(fill = "white")) + 
  # facet_wrap(~advent) +
  ggtitle("OFC")

hg_eda_summary %>%
  filter(grepl(paste(insula_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) +
  # geom_vline(xintercept = 1.2613816 * 1000) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(9)) +
  scale_color_manual(values = getPalette(9)) +
  labs(y = "high gamma") +
  ggtitle("Insula")

hg_eda_summary %>%
  filter(grepl(paste(mfg_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 1000) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(25)) +
  scale_color_manual(values = getPalette(25)) +
  ggtitle("MFG")

hg_eda_summary %>%
  filter(grepl(paste(sts_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 100) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(15)) +
  scale_color_manual(values = getPalette(15)) +
  ggtitle("STS")

hg_eda_summary %>%
  filter(grepl(paste(hinal_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 10) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(9)) +
  scale_color_manual(values = getPalette(9)) +
  ggtitle("Perihinal & Entrohinal")

hg_eda_summary %>%
  filter(grepl(paste(ca1_elecs$Electrode, collapse = "|"), electrodes)) %>%
  ggplot(., aes(x = bin, y = mean, color = electrodes, fill = electrodes)) +
  geom_point(alpha = .4) +
  geom_line(alpha = .4) + 
  # geom_vline(xintercept = 1.2613816 * 100) +
  theme(panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = getPalette(9)) +
  scale_color_manual(values = getPalette(9)) +
  ggtitle("CA1")

```

```{r hg_plots}

file_path_to_electrode_names <- path(here(), "munge", "IR35_electrodes_presentation_locked_extended.csv")
file_path_to_hg_data <- path(here(), "munge", "IR35_hg_munge_presentation_locked_extended.csv")
file_path_to_elecs_of_interest <- path(here(), "munge", "IR35_elecs_of_interest.csv")

# load data #
# IR39
# hg_data_full <- load_high_gamma_data(file_path_to_hg_data, file_path_to_electrode_names, "V2702", "V2703")
# IR35
hg_data_full <- load_high_gamma_data(file_path_to_hg_data, file_path_to_electrode_names)
elecs_to_use <- read.csv(file_path_to_elecs_of_interest)

indicies <- hg_data_full %>% select(trial, electrodes)
hg_data <- hg_data_full %>% select(starts_with("time"))

baseline_df <- hg_data[, 1:200]
baseline <- apply(baseline_df, 1, function(x) mean(x, na.rm = T))

hg_data_tmp <- hg_data
hg_data_baselined <- apply(hg_data_tmp, 2, function(col) t(as.vector(col - baseline)))
hg_data_baselined <- as.data.frame(hg_data_baselined)
hg_data_baselined <- cbind(hg_data_baselined, indicies)

hg_raw_plot <- merge.data.frame(hg_data_baselined, behave_data, by.x = "trial", by.y = "round", all.x = T, all.y = F)

ofc_elecs <- elecs_to_use %>% filter(ofc_loc_meeting == 1) %>% select(Electrode)
insula_elecs <- elecs_to_use %>% filter(insula_loc_meeting == 1) %>% select(Electrode)
mfg_elecs <- elecs_to_use %>% filter(mfg_loc_meeting == 1) %>% select(Electrode)
sts_elecs <- elecs_to_use %>% filter(sts_loc_meeting == 1) %>% select(Electrode)
hinal_elecs <- elecs_to_use %>% filter(hinal_loc_meeting == 1) %>% select(Electrode)
ca1_elecs <- elecs_to_use %>% filter(ca1_loc_meeting == 1) %>% select(Electrode)

elecs_of_interest <- c(as.character(ofc_elecs$Electrode), as.character(insula_elecs$Electrode), as.character(sts_elecs$Electrode))

elec_names <- unique(hg_raw_plot$electrodes[grepl(paste(elecs_of_interest, collapse = "|"), hg_raw_plot$electrodes)])

advent_plot_df <- hg_raw_plot %>%
  mutate(advent = if_else(ineq_disadvent > 0, "Advantageous", "Inadvantageous")) %>%
  filter(advent == "Advantageous") %>%
  select(electrodes, RT, advent, trial, starts_with("time")) %>%
  arrange(desc(RT))

disadvent_plot_df <- hg_raw_plot %>%
  mutate(advent = if_else(ineq_disadvent > 0, "Advantageous", "Disadvantageous")) %>%
  filter(advent == "Disadvantageous") %>%
  select(electrodes, RT, advent, trial, starts_with("time")) %>%
  arrange(desc(RT)) 

advent_choice_plot_df <- hg_raw_plot %>%
  filter(chose_equality == "Advent") %>%
  select(electrodes, RT, chose_equality, trial, starts_with("time")) %>%
  arrange(desc(RT))

ten_ten_plot_df <- hg_raw_plot %>%
  filter(chose_equality == "10-10") %>%
  select(electrodes, RT, chose_equality, trial, starts_with("time")) %>%
  arrange(desc(RT)) 

for(elec in elec_names) {

  
adv_plot <- advent_plot_df %>%
  filter(electrodes == elec) %>%
  mutate(trial = factor(trial, levels = trial)) %>%
  gather(key = "time", value = "gamma", -electrodes, -trial, -RT, -advent) %>%
  mutate(time = (as.numeric(gsub("time_", "", time))) -200 ) %>%
  group_by(RT) %>%
  mutate(time = time - RT*1000) %>%
  mutate(time = time) %>%
  ggplot(., aes(x = time, y = trial, color = gamma, fill = gamma)) +
  geom_tile() + 
  geom_point(aes(y = trial, x = -RT*1000), color = "white", size = 1) +
  # geom_point(aes(y = trial, x = RT*1000), color = "white", size = 1) +
  geom_vline(xintercept = -200, color = "white") +
  geom_vline(xintercept = -400, color = "white") +
  geom_vline(xintercept = -600, color = "white") +
  geom_vline(xintercept = -800, color = "white") +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  scale_fill_viridis(limits = c(-1, 2), begin = 0, end = 1)   +
  scale_color_viridis(limits = c(-1, 2), begin = 0, end = 1) +
  ggtitle(paste0(elec, " -- Advantageous"))
 
dis_plot  <- disadvent_plot_df %>%
  filter(electrodes == elec) %>%
  mutate(trial = factor(trial, levels = trial)) %>%
  gather(key = "time", value = "gamma", -electrodes, -trial, -RT, -advent) %>%
  mutate(time = (as.numeric(gsub("time_", "", time))) -200 ) %>%
  group_by(RT) %>%
  mutate(time = time - RT*1000) %>%
  ggplot(., aes(x = time, y = trial, color = gamma, fill = gamma)) +
  geom_tile() + 
  geom_point(aes(y = trial, x = -RT*1000), color = "white", size = 1) +
  geom_vline(xintercept = 0, color = "white") +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  scale_fill_viridis(limits = c(-1, 2), begin = 0, end = 1)   +
  scale_color_viridis(limits = c(-1, 2), begin = 0, end = 1) +
  ggtitle(paste0(elec, " -- Disadantageous"))

  ggsave(filename = paste0('./figures/IR35/choice_locked_adv-vs-dis/', elec, "_adv.png"),
     device = "png",
     width = 10,
     height = 10,
     units = "cm",
     dpi = 200,
     plot =  print(plot(adv_plot)) ) 
  
    ggsave(filename = paste0('./figures/IR35/choice_locked_adv-vs-dis/', elec, "_dis.png"),
     device = "png",
     width = 10,
     height = 10,
     units = "cm",
     dpi = 200,
     plot =  print(plot(dis_plot)) ) 

} 

hg_behave_plot_100_bins <- hg_behave
hg_behave_plot_200_bins <- hg_behave
colnames(hg_behave_plot_200_bins) <- gsub("pre_", "_-", colnames(hg_behave_plot_200_bins))
colnames(hg_behave_plot_200_bins) <- gsub("post", "", colnames(hg_behave_plot_200_bins))

hg_behave_plot_200_bins %>%
  mutate(advent = if_else(ineq_disadvent > 0, "Advantageous", "Inadvantageous")) %>%
  filter(advent == "Inadvantageous") %>%
  select(electrodes, RT, advent, trial, starts_with("_")) %>%
  arrange(desc(RT)) %>%
  filter(electrodes == elec) %>%
  mutate(trial = factor(trial, levels = trial)) %>%
  gather(key = "time", value = "gamma", -electrodes, -trial, -RT, -advent) %>%
  mutate(time = (as.numeric(gsub("_", "", time))) *150 ) %>%
  ggplot(., aes(x = time, y = trial, color = gamma, fill = gamma)) +
  geom_tile() + 
  # geom_point(aes(y = trial, x = -RT*150), color = "white", size = 1) +
  geom_vline(xintercept = 0, color = "white") +
  theme(axis.text.y = element_blank(), axis.ticks.y = element_blank()) + 
  scale_fill_viridis(limits = c(-1, 1.5), begin = 0, end = 1)   +
  scale_color_viridis(limits = c(-1, 1.5), begin = 0, end = 1) +
  ggtitle(paste0(elec, " -- Inadvantageous"))


```

```{r scatter-plots}


scatter_prep <- hg_raw_plot %>%
  select(electrodes, trial, ineq_var_abs, starts_with("time")) %>%
  mutate(electrodes = as.character(electrodes)) %>%
  filter(electrodes %in% as.character(elec_names)) %>%
  gather(key = "time", value = "gamma", -electrodes, -trial, -ineq_var_abs) %>%
  # mutate(time = as.numeric(gsub("time_", "", time))) %>%
  group_by(trial, electrodes) %>%
  mutate(median_gamma = median(gamma, na.rm = T)) %>%
  mutate(upper_gamma = median(gamma[gamma > median_gamma], na.rm = T)) %>%
  mutate(upper_quart = mean(gamma[gamma > upper_gamma], na.rm  = T)) %>%
  select(-time, -gamma, -median_gamma, -upper_gamma) 

scatter_prep %>% filter(!duplicated(upper_quart)) %>%
    ggplot(., aes(x = ineq_var_abs, y = upper_quart)) +
    geom_point() + 
    facet_wrap(~electrodes) +
    ggtitle(paste0("Absolute Inequality"))


scatter_prep_ineq <- hg_raw_plot %>%
  select(electrodes, trial, ineq_advent, ineq_disadvent, starts_with("time")) %>%
  mutate(electrodes = as.character(electrodes)) %>%
  filter(electrodes %in% as.character(elec_names)) %>%
  gather(key = "time", value = "gamma", -electrodes, -trial, -ineq_advent, -ineq_disadvent) %>%
  # mutate(time = as.numeric(gsub("time_", "", time))) %>%
  group_by(trial, electrodes) %>%
  mutate(median_gamma = median(gamma, na.rm = T)) %>%
  mutate(upper_gamma = median(gamma[gamma > median_gamma], na.rm = T)) %>%
  mutate(upper_quart = mean(gamma[gamma > upper_gamma], na.rm  = T)) %>%
  select(-time, -gamma, -median_gamma, -upper_gamma) 

scatter_prep_ineq %>% filter(!duplicated(upper_quart)) %>%
    gather(key= "inequality", value = "quantity", -electrodes, -trial, -upper_quart) %>%
    ggplot(., aes(x = quantity, y = upper_quart, color = inequality)) +
    geom_point() + 
    facet_wrap(~electrodes) +
    ggtitle(paste0("Absolute Inequality"))



```


```{r regressions, eval=FALSE}

# see ./analysis/batch_regression_script_par.R for current regression analyses #

```

```{r fake, eval=FALSE}

fake_adv <- read.csv(path(here(), "results", "fake_results_advantageous.csv"))
fake_dis <- read.csv(path(here(), "results", "fake_results_disadvantageous.csv"))

fake_adv %>%
  select (-X) %>%
  kable() %>%
  add_header_above(c("FAKE: Advantageous Inequity" = 8)) %>%
  kable_styling(position = "center")


fake_dis %>%
  select (-X) %>%
  kable() %>%
  add_header_above(c("FAKE: Disadvantageous Inequity" = 8)) %>%
  kable_styling(position = "center")

```


```{r concatenate-results-presentation}

# combine different csvs #
regions_to_combine <- c("OFC", "Insula", "Cingulate", "STS")
presentation_results <- compile_results(regions_to_combine, type = "pres-locked", sub = "IR39")

# runa anova for inequity results #
path_hg_clean <- path(here(), "munge", "IR39", "hg_behave_presentation_locked.csv")
hg_behave <-  read.csv(path_hg_clean)
run_filtered_anova(presentation_results, hg_behave, sub = "IR39", region_name = "All", all_results = T, type = "pres-locked")

# read back in the results #
region_name <- "All"
adv_pres_results_for_plots <- read.csv(fs::path(here(), "results", "IR39", paste0(region_name, "_pres-locked_anova_results_advantageous.csv")))
dis_pres_results_for_plots <- read.csv(fs::path(here(), "results", "IR39", paste0(region_name, "_pres-locked_anova_results_disadvantageous.csv")))
```


```{r concatenate-results-choice}

# combine different csvs #
regions_to_combine <- c("OFC", "Insula", "Cingulate", "STS")
choice_results <- compile_results(regions_to_combine, type = "choice-locked")

# runa anova for inequity results #
path_hg_clean <- path(here(), "munge", "hg_behave_choice_locked_cut_fixation.csv")
hg_behave <-  read.csv(path_hg_clean)
run_filtered_anova(choice_results, hg_behave,  region_name = "All", all_results = T, type = "choice-locked")

# read back in the results #
region_name <- "All"
adv_choice_results_for_plots <- read.csv(fs::path(here(), "results", paste0(region_name, "_choice-locked_anova_results_advantageous.csv")))
dis_choice_results_for_plots <- read.csv(fs::path(here(), "results", paste0(region_name, "_choice-locked_anova_results_disadvantageous.csv")))
```

```{r plot-filter-anovas-presentation}
ggthemr::ggthemr("pale", layout = "plain")
getPalette = colorRampPalette(brewer.pal(3, "Set1"))


ineq_plots <- function(df, title) {
# plots the bar plots of dif in R2 for inequity  
df %>%
    ungroup() %>%
    mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_p < 0.05, "Significant", "Insignificant")) %>%
    mutate_cond(sig == "Significant", sig = as.character(region)) %>%
    mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
    # mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
    ggplot(., aes( x = bin, y = diff_adj_r2, color = sig, fill = sig)) +
    geom_col(alpha = .5) +
    # geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
    theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
    scale_fill_manual(values = c("grey", getPalette(3))) +
    scale_color_manual(values = c("grey", getPalette(3))) +
    labs(y = "Difference in Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
    facet_wrap(~electrode) + 
    ggtitle(title)
  
}

active_elec_plots <- function(df, var, title) {
  df %>%
    filter(predictor == var) %>%
    mutate(sig = if_else(perm_p < 0.05 & p < 0.05, "Significant", "Insignificant")) %>%
    mutate_cond(sig == "Significant", sig = as.character(region)) %>%
    mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
    # mutate(bin = factor(bin, levels = colnames(hg_data)[4:38])) %>%
    ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
    geom_col(alpha = .5) +
    # geom_vline(aes(xintercept = which(levels(bin) %in% "post_1"))) +
    theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
    scale_fill_manual(values = c("grey", getPalette(4))) +
    scale_color_manual(values = c("grey", getPalette(4))) +
    labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
    facet_wrap(~electrode) + 
    ggtitle(title)

}

ineq_plots(adv_pres_results_for_plots, "Advantageous Inequality Results")

ineq_plots(dis_pres_results_for_plots, "Disdvantageous Inequality Results")

active_elec_plots(presentation_results, "ineq_advent", "Adv Ineq Results")

active_elec_plots(presentation_results, "ineq_disadvent", "Dis Ineq Results")

active_elec_plots(presentation_results, "self_payoff", "Self Payoff Results")

active_elec_plots(presentation_results, "self_foregone", "Self Forgeone Results")

active_elec_plots(presentation_results, "other_payoff", "Other Payoff Results")

active_elec_plots(presentation_results, "other_foregone", "Other Forgeone Results")

```

```{r correct-filtered-anovas-presentation}

adv_pres_results_for_plots %>%
  mutate_cond(perm_p < .05 & p < .05, anova_p = p.adjust(anova_p, "hochberg")) %>%
  ineq_plots(., "Advantageous Inequality Results")

dis_pres_results_for_plots %>%
  mutate_cond(perm_p < .05 & p < .05, anova_p = p.adjust(anova_p, "hochberg")) %>%
  ineq_plots(., "Disdvantageous Inequality Results")


```

```{r plot-filter-anovas-choice}

ineq_plots <- function(df, title) {
# plots the bar plots of dif in R2 for inequity  
df %>%
    mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_p < 0.05, "Significant", "Insignificant")) %>%
    mutate_cond(sig == "Significant", sig = as.character(region)) %>%
    mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
    mutate(bin = factor(bin, levels = colnames(hg_behave)[4:49])) %>%
    ggplot(., aes( x = bin, y = diff_adj_r2, color = sig, fill = sig)) +
    geom_col(alpha = .5) +
    geom_vline(aes(xintercept = which(levels(bin) %in% "post_1")), color = "#081D58") +
    geom_vline(aes(xintercept = which(levels(bin) %in% "post_20")), color = "#F2AD00") +
    theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
    scale_fill_manual(values = c("grey", getPalette(3))) +
    scale_color_manual(values = c("grey", getPalette(3))) +
    labs(y = "Difference in Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
    facet_wrap(~electrode) + 
    ggtitle(title)
  
}

active_elec_plots <- function(df, var, title) {
  df %>%
    filter(predictor == var) %>%
    mutate(sig = if_else(perm_p < 0.05 & p < 0.05, "Significant", "Insignificant")) %>%
    mutate_cond(sig == "Significant", sig = as.character(region)) %>%
    mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
    mutate(bin = factor(bin, levels = colnames(hg_behave)[4:49])) %>%
    ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
    geom_col(alpha = .5) +
    geom_vline(aes(xintercept = which(levels(bin) %in% "post_1")), color = "#081D58") +
    geom_vline(aes(xintercept = which(levels(bin) %in% "post_20")), color = "#F2AD00") +
    theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
    scale_fill_manual(values = c("grey", getPalette(4))) +
    scale_color_manual(values = c("grey", getPalette(4))) +
    labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
    facet_wrap(~electrode) + 
    ggtitle(title)

}

ineq_plots(adv_choice_results_for_plots, "Advantageous Inequality Results")

ineq_plots(dis_choice_results_for_plots, "Disdvantageous Inequality Results")

active_elec_plots(choice_results, "ineq_advent", "Adv Ineq Results")

active_elec_plots(choice_results, "ineq_disadvent", "Dis Ineq Results")

active_elec_plots(choice_results, "self_payoff", "Self Payoff Results")

active_elec_plots(choice_results, "self_foregone", "Self Forgeone Results")

active_elec_plots(choice_results, "other_payoff", "Other Payoff Results")

active_elec_plots(choice_results, "other_foregone", "Other Forgeone Results")


```

```{r correct-filtered-anovas-choice}

adv_choice_results_for_plots %>%
  mutate_cond(perm_p < .05 & p < .05, anova_p = p.adjust(anova_p, "hochberg")) %>%
  ineq_plots(., "Advantageous Inequality Results")

dis_choice_results_for_plots %>%
  mutate_cond(perm_p < .05 & p < .05, anova_p = p.adjust(anova_p, "hochberg")) %>%
  ineq_plots(., "Disdvantageous Inequality Results")


```

```{r stepwise-anovas-prep, eval =F}

# concatenate results #
regions_to_combine <- c("OFC", "Insula", "Cingulate", "STS")
anova_results <- merge_stepped_anova_results(regions_to_combine)

anova_regression_results <- merge.data.frame(anova_results, regression_results, by.x = c("electrode", "region", "first_pred"), by.y = c("electrode", "region", "predictor"), all.x = T, all.y = F)

```

```{r stepwise-anova-viz, eval = F}

anova_regression_results %>%
  filter(first_pred == "ineq_advent") %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Ineq Advent Stepped Anova Results: all sig except self foregone")


anova_regression_results %>%
  filter(first_pred == "ineq_disadvent" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Ineq Disdvent Stepped Anova Results:  all sig ")

anova_regression_results %>%
  filter(first_pred == "self_payoff" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Self Payoff Stepped Anova Results:  all sig ")

anova_regression_results %>%
  filter(first_pred == "other_payoff" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Other Payoff Stepped Anova Results:  all sig except ineq disadvant")

anova_regression_results %>%
  filter(first_pred == "self_foregone" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Self Foregone Stepped Anova Results:  all sig except ineq disadvant")

anova_regression_results %>%
  filter(first_pred == "other_foregone" & complete.cases(anova_perm_p)) %>%
  mutate(sig = if_else(perm_p < 0.05 & p < 0.05 & anova_perm_p, "Significant", "Insignificant")) %>%
  mutate_cond(sig == "Significant", sig = as.character(region)) %>%
  mutate(sig = relevel(factor(sig), ref = "Insignificant")) %>%
  ggplot(., aes( x = bin, y = R2, color = sig, fill = sig)) +
  geom_col(alpha = .5) +
  theme(axis.text.x = element_blank(), axis.ticks.x = element_blank(), panel.background = element_rect(fill = "white")) + 
  scale_fill_manual(values = c("grey", getPalette(4))) +
  # scale_color_grey() +
  scale_color_manual(values = c("grey", getPalette(4))) +
  labs(y = "Adj. R Squared", x = "Bins", fill = "Region", color = "Region") +
  facet_wrap(~electrode) + 
  ggtitle("Other Forgeone Stepped Anova Results: all sig except ineq disadvant")


```


# Prediction HG -> choice

maybe after regions are identified in first couple of subjects so it can be truly uniased in the later subjects

